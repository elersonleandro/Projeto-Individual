<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/chessboard-1.0.0.js"></script>
    <link rel="stylesheet" href="css/chessboard-1.0.0.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"
        integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous">
    </script>
    <script src="js/stockfish.js"></script>
</head>

<body>
    <div id="myBoard" style="width: 400px"></div>
    <div id="bestMove"></div>
    <div id="message"></div>
</body>

</html>
<script>
    var game = new Chess();
    var board;
    var engine = new Worker('js/stockfish.js');
    var moveCount = 0;
    var moves = [];

    engine.postMessage('uci');

    engine.onmessage = function (event) {
        var line = event.data;
        if (line.startsWith('bestmove')) {
            var bestMove = line.split(' ')[1];
            moves.push(bestMove);
            game.move({
                from: bestMove.substring(0, 2),
                to: bestMove.substring(2, 4),
                promotion: 'q'
            });
            moveCount++;
            if (moveCount < 50 && !game.game_over()) {
                makeBestMove();
            } else if (moveCount === 50 || game.game_over()) {
                board.position(game.fen());
            }
        }
    };

    function makeBestMove() {
        var fen = game.fen();
        var depth = game.turn() === 'w' ? 8 : 2;
        engine.postMessage('position fen ' + fen);
        engine.postMessage('go depth ' + depth);
    }

    function startGame() {
        // Inicia o cálculo dos 30 movimentos
        makeBestMove();
    }

    function initializeBoard() {
        board = Chessboard('myBoard', {
            draggable: true,
            position: game.fen(),
            onDrop: handleMove
        });
    }

    function handleMove(source, target) {
        var move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        if (move === null) return 'snapback';

        moveCount++;

        if (moveCount < 50) {
            makeBestMove()
        }
    }

    $(document).ready(function () {
        startGame();
        // Espera até que os 30 movimentos sejam calculados
        var interval = setInterval(function() {
            if (moveCount >= 50 || game.game_over()) {
                clearInterval(interval);
                initializeBoard();
            }
        }, 100);
    });
</script>
