<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChesStudent | Dashboard</title>
    <link rel="icon" href="../assets/imgs/logo.png">
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="./../css/dashboards.css">
    <!-- <script src="../js/sessao.js"></script> -->
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>

    <body>
        <nav class="menu-lateral">

            <h2>ChesStudent</h2>
            <ul>
                <h3>Descubra</h3>
                <li class="item-menu">
                    <a href="../home.html">
                        <span class="icon"><i class="bi bi-house"></i></span>
                        <span class="txt-link">Home</span>
                    </a>
                </li>
                <li class="item-menu">
                    <a href="#">
                        <span class="icon"><i class="bi bi-bar-chart"></i></span>
                        <span class="txt-link">Dashboard</span>
                    </a>
                </li>
                <li class="item-menu">
                    <a href="../ProblemaFinal.html">
                        <span class="icon"><i class="bi bi-puzzle"></i>
                        </span>
                        <span class="txt-link">Resolva problemas</span>
                    </a>
                </li>
                <li class="item-menu">
                    <a href="../Partida.html">
                        <span class="icon"><i class="bi bi-broadcast"></i>
                        </span>
                        <span class="txt-link">Partida</span>
                    </a>
                </li>
                <h3>Aprender</h3>
                <li class="item-menu">
                    <a href="#">
                        <span class="icon"><i class="bi bi-book-half"></i>
                        </span>
                        <span class="txt-link">Peças</span>
                    </a>
                </li>
                <li class="item-menu">
                    <a href="#">
                        <span class="icon"><i class="bi bi-person-bounding-box"></i></span>
                        <span class="txt-link">Jogadores</span>
                    </a>
                </li>
                <li class="item-menu">
                    <a href="#">
                        <span class="icon"><i class="bi bi-people-fill"></i></span>
                        <span class="txt-link">Campeonatos</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="dash">
            <div class="usuario">
                <div id="usuario"></div>
            </div>
            <hr>
            <div class="ranking">
                <p>Ranking Problemas</p>
                <p>Ranking Partidas</p>
            </div>
            <div class="ranking">
                <table id="rankingTable">
                    <thead class="thead">
                        <tr>
                            <th class="nome">Nome</th>
                            <th class="tempo">Tempo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                <table id="rankingTablePar">
                    <thead>
                        <tr>
                            <th class="nome">Nome</th>
                            <th class="tempo">Tempo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="nome"></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- <div id="b_usuario"></div> -->
            <hr>
            <div class="linhagrafico">
                <div class="graficos">
                    <p>Experiencia</p>
                    <canvas id="myChartCanvas"></canvas>
                </div>
                <div class="graficos">
                    <p>Frequencia</p>
                    <canvas id="myChartCanvasFreq"></canvas>
                </div>
                <div class="graficos">
                    <p>Tipo de partidas</p>
                    <canvas id="myChartCanvasTipo"></canvas>
                </div>
                <div class="graficos">
                    <p>Motivo</p>
                    <canvas id="myChartCanvasMotivo"></canvas>
                </div>
            </div>
            <hr>
        </div>


    </body>

</html>

<script>
    // b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;
    obterDadosUsuario()
    obterExperiencia()
    obterFrequencia()
    obterTipo()
    obterMotivo()
    obterRankingProblema()
    obterRankingPartida()

    var nome
    var tentativasProblemas
    var tentativasPartidas
    var acertosProblemas
    var acertosPartidas
    var menorTempoProblema
    var menorTempoPartida
    var idPreferencia
    var experiencia
    var frequencia
    var tipoPartida
    var motivacao

    function obterDadosUsuario() {
        fetch("/medidas/buscar/usuario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idusuarioServer: sessionStorage.ID_USUARIO
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO OBTERDADOUSUARIO()!")
            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json))
                    nome = json.nome
                    tentativasProblemas = json.tentativasProblemas
                    tentativasPartidas = json.tentativasPartidas
                    acertosProblemas = json.acertosProblemas
                    acertosPartidas = json.acertosPartidas
                    menorTempoProblema = json.menorTempoProblemas
                    menorTempoPartida = json.menorTempoPartida
                    idPreferencia = json.idPreferencia
                    experiencia = json.experiencia
                    frequencia = json.frequencia
                    tipoPartida = json.tipoPartida
                    motivacao = json.motivacao
                });
                console.log(resposta)
                atualizarHTML()
            }
            else {
                console.log('erro ao buscar dados')
            }
        }).catch(function (erro) {
            console.error('Erro:', erro);
        });

    }
    function atualizarHTML() {
            const dadosUsuarioDiv = document.getElementById("usuario");
            const html = `
                <div class="user-data">
                    <h2>Dados do Usuário</h2>
                    <p><strong>ID:</strong> ${idPreferencia}</p>
                    <p><strong>Nome:</strong> ${nome}</p>
                    <p><strong>Xeque-Mate Problemas:</strong> ${tentativasProblemas}</p>
                    <p><strong>Xeque-Mate Partidas:</strong> ${tentativasPartidas}</p>
                    <p><strong>Acertos Problemas:</strong> ${acertosProblemas}%</p>
                    <p><strong>Acertos Partidas:</strong> ${acertosPartidas}%</p>
                    <p><strong>Menor Tempo Problemas:</strong> ${menorTempoProblema} segundos</p>
                    <p><strong>Menor Tempo Partida:</strong> ${menorTempoPartida} segundos</p>
                    <p><strong>Experiência:</strong> ${experiencia}</p>
                    <p><strong>Frequência:</strong> ${frequencia}</p>
                    <p><strong>Tipo de Partida:</strong> ${tipoPartida}</p>
                    <p><strong>Motivação:</strong> ${motivacao}</p>
                </div>
            `;
            dadosUsuarioDiv.innerHTML = html;
        }

        document.addEventListener("DOMContentLoaded", obterDadosUsuario);

    function obterRankingProblema() {
        fetch('/medidas/buscar/rankingProblema', { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarRankingProblema(resposta)
                })
            }
            else {
                console.error('Errado')
            }
        })
    }

    function plotarRankingProblema(resposta) {
        const rows = document.querySelectorAll("#rankingTable tbody tr");

        for (let i = 0; i < rows.length; i++) {
            const nomeCell = rows[i].cells[0];
            const tempoCell = rows[i].cells[1];

            if (i < resposta.length) {
                nomeCell.textContent = resposta[i].nome;
                tempoCell.textContent = resposta[i].tempo;
            } else {
                nomeCell.textContent = "";  // Limpa a célula se não houver dados
                tempoCell.textContent = "";  // Limpa a célula se não houver dados
            }
        }
    }
    function obterRankingPartida() {
        fetch('/medidas/buscar/rankingPartida', { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarRankingPartida(resposta)
                })
            }
            else {
                console.error('Errado')
            }
        })
    }

    function plotarRankingPartida(resposta) {
        const rows = document.querySelectorAll("#rankingTablePar tbody tr");

        for (let i = 0; i < rows.length; i++) {
            const nomeCell = rows[i].cells[0];
            const tempoCell = rows[i].cells[1];

            if (i < resposta.length) {
                nomeCell.textContent = resposta[i].nome;
                tempoCell.textContent = resposta[i].tempo;
            } else {
                nomeCell.textContent = "";  // Limpa a célula se não houver dados
                tempoCell.textContent = "";  // Limpa a célula se não houver dados
            }
        }
    }

    function obterExperiencia() {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/buscar/experiencia`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Iniciante', 'Mestre', 'Intermediário', 'Avançado'];

        // Inicializando os dados do gráfico
        let dados = {
            labels: labels,
            datasets: [{
                label: '',
                data: [0, 0, 0, 0],  // Inicializa os valores com 0
                backgroundColor: [
                    '#006d2c',
                    '#b2e2e2',
                    '#66c2a4',
                    '#238b45',
                ],
                borderColor: [
                    '#bdd7e7',
                    '#6baed6',
                    '#3182bd',
                    '#08519c'
                ],
                borderWidth: .5
            }]
        };

        console.log('----------------------------------------------');
        console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGrafico":');
        console.log(resposta);

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[0].data[0] += parseInt(registro.iniciante);
            dados.datasets[0].data[1] += parseInt(registro.mestre);
            dados.datasets[0].data[2] += parseInt(registro.intermediario);
            dados.datasets[0].data[3] += parseInt(registro.avancado);
        }

        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets[0].data);
        console.log('----------------------------------------------');

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'pie',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChartCanvas'),
            config
        );
    }

    function obterFrequencia() {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/buscar/frequencia`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoFreq(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGraficoFreq(resposta) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Diariamente', 'Semanalmente', 'Mensalmente', 'Raramente'];

        // Inicializando os dados do gráfico
        let dados = {
            labels: labels,
            datasets: [{
                label: '',
                data: [0, 0, 0, 0],  // Inicializa os valores com 0
                backgroundColor: [
                    '#bdd7e7',
                    '#6baed6',
                    '#3182bd',
                    '#08519c'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: .5
            }]
        };

        console.log('----------------------------------------------');
        console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGrafico":');
        console.log(resposta);

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[0].data[0] += parseInt(registro.diariamente);
            dados.datasets[0].data[1] += parseInt(registro.semanalmente);
            dados.datasets[0].data[2] += parseInt(registro.mensalmente);
            dados.datasets[0].data[3] += parseInt(registro.raramente);
        }

        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets[0].data);
        console.log('----------------------------------------------');

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'pie',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChartCanvasFreq'),
            config
        );
    }
    function obterTipo() {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/buscar/tipo`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoTipo(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function plotarGraficoTipo(resposta) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Casual', 'Classicas', 'Problemas', 'Rápidas'];

        // Inicializando os dados do gráfico
        let dados = {
            labels: labels,
            datasets: [{
                label: '',
                data: [0, 0, 0, 0],  // Inicializa os valores com 0
                backgroundColor: [
                    '#cccccc',
                    '#969696',
                    '#636363',
                    '#252525'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        };

        console.log('----------------------------------------------');
        console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGrafico":');
        console.log(resposta);

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[0].data[0] += parseInt(registro.casual);
            dados.datasets[0].data[1] += parseInt(registro.classicas);
            dados.datasets[0].data[2] += parseInt(registro.problemas);
            dados.datasets[0].data[3] += parseInt(registro.rapidas);
        }

        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets[0].data);
        console.log('----------------------------------------------');

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'pie',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChartCanvasTipo'),
            config
        );
    }
    function obterMotivo() {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/buscar/motivo`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoMotivo(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function plotarGraficoMotivo(resposta) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Diversão', 'Desafio Mental', 'Competição', 'Aprendizado'];

        // Inicializando os dados do gráfico
        let dados = {
            labels: labels,
            datasets: [{
                label: '',
                data: [0, 0, 0, 0],  // Inicializa os valores com 0
                backgroundColor: [
                    '#fdbe85',
                    '#fd8d3c',
                    '#e6550d',
                    '#a63603'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        };

        console.log('----------------------------------------------');
        console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGrafico":');
        console.log(resposta);

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[0].data[0] += parseInt(registro.diversao);
            dados.datasets[0].data[1] += parseInt(registro.desafio);
            dados.datasets[0].data[2] += parseInt(registro.competicao);
            dados.datasets[0].data[3] += parseInt(registro.aprendizado);
        }

        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets[0].data);
        console.log('----------------------------------------------');

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'pie',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChartCanvasMotivo'),
            config
        );
    }







    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idAquario, dados, myChart) {



        fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterdados(idAquario);
                    // alertar(novoRegistro, idAquario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idAquario}`)
                    avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>