<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/chessboard-1.0.0.js"></script>
    <link rel="stylesheet" href="css/chessboard-1.0.0.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"
        integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous">
        </script>
    <script src="js/stockfish.js"></script>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/problema.css">
</head>

<body>
    <nav class="menu-lateral">

        <h2>ChesStudent</h2>
        <ul>
            <h3>Descubra</h3>
            <li class="item-menu">
                <a href="../home.html">
                    <span class="icon"><i class="bi bi-house"></i></span>
                    <span class="txt-link">Home</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="#">
                    <span class="icon"><i class="bi bi-bar-chart"></i></span>
                    <span class="txt-link">Dashboard</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="chessboardjs-1.0.0/Problema.html">
                    <span class="icon"><i class="bi bi-puzzle"></i>
                    </span>
                    <span class="txt-link">Resolva problemas</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="#">
                    <span class="icon"><i class="bi bi-broadcast"></i>
                    </span>
                    <span class="txt-link">Desenvolvedor</span>
                </a>
            </li>
            <h3>Aprender</h3>
            <li class="item-menu">
                <a href="#">
                    <span class="icon"><i class="bi bi-book-half"></i>
                    </span>
                    <span class="txt-link">Peças</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="#">
                    <span class="icon"><i class="bi bi-person-bounding-box"></i></span>
                    <span class="txt-link">Jogadores</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="#">
                    <span class="icon"><i class="bi bi-people-fill"></i></span>
                    <span class="txt-link">Campeonatos</span>
                </a>
            </li>
        </ul>
    </nav>
    <div class="conteiner">
        <div>
            <div id="myBoard" style="width: 400px"></div>
            <div id="bestMove"></div>
            <div id="message"></div>
            <div id="jogadas_anteriores"></div>
            <span>Tempo: <span class="timer">00</span></span>
        </div>
        <div style="width: 30vw;">
            <h2>Vamos lá</h2>
            <p>O sistema irá fazer 100 jogadas aleatórias, Depois disso você jogará contra o Stockfish, Irei te
                acompanhar, você também pode selecionar o nível do Stockfish de 0 a 15</p>
            <input type="number" id="input_nivel"><button onclick="mudardepth()">Enviar</button>
        </div>
    </div>
</body>

</html>
<script>
    const timer = document.querySelector('.timer');
    var nivel = 8;
    var bestMoveElement = document.getElementById('bestMove'); // Armazenar referência ao elemento DOM
    function finalizar() {
        var tempo = Number(contadorValue)
        fetch("/quiz/inserirproblema", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                tempoServer: tempo,
                idUsuarioServer: Number(sessionStorage.ID_USUARIO),
                fkjogoServer: 2
            })
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    setTimeout(() => {
                        window.location = "Partida.html";
                    }, "2000");
                } else {
                    alert('Erro');
                }
            })
    }

    function mudardepth() {
        nivel = Number(input_nivel.value);
    }


    function movimentoEngine() {
        var melhorJogada = bestMoveElement.innerText.split(' ')[2]; // Usar a referência armazenada
        var inicio = melhorJogada.slice(0, 2);
        var fim = melhorJogada.slice(2, 4);
        jogo.move({
            from: inicio,
            to: fim,
            promotion: 'q'
        });
        var tabuleiro = jogo.fen();
        board.position(tabuleiro);
        engine.postMessage('position fen ' + tabuleiro);
        engine.postMessage(`go depth ${nivel}`);
    }

    var engine = new Worker('js/stockfish.js');

    engine.postMessage('uci');
    engine.postMessage('position fen rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');

    engine.postMessage(`go depth 4`);

    engine.onmessage = function (event) {
        var melhorJogada = event.data.split(' ')[1];
        bestMoveElement.innerText = 'Melhor jogada: ' + melhorJogada;
    };

    var jogo = new Chess(); // Inicializar o jogo com o tabuleiro padrão
    var config = {
        position: 'start', // Definindo a posição inicial como a posição padrão de um jogo de xadrez
        draggable: true,
        onDrop: function (source, target) {
            var movimento = jogo.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            if (movimento !== null) {
                tabuleiro = jogo.fen();
                board.position(tabuleiro);

                engine.postMessage('position fen ' + tabuleiro);
                engine.postMessage('go depth 8');
                var melhorJogada = bestMoveElement.innerText.split(' ')[2]; // Usar a referência armazenada
                lista_movimentos.push(source + target);
                jogadas_anteriores.innerHTML = `Suas jogadas ${lista_movimentos}`;
                if (jogo.in_checkmate()) {
                    stopTimer()
                    var vencedor = jogo.turn() === 'w' ? 'Preto' : 'Branco';
                    alert('Fim de jogo! Xeque-mate. Vencedor: ' + vencedor);
                    if (vencedor == 'Branco') {
                        finalizar()
                        calcularAcertos()
                    }
                    else {
                        calcularAcertos()
                    }
                    return true;
                } else if (jogo.in_draw()) {
                    stopTimer()
                    alert('Fim de jogo! Empate.');
                    return true;
                } else if (jogo.in_stalemate()) {
                    stopTimer()
                    alert('Fim de jogo! Afogamento.');
                    return true;
                }
                else {
                    if (source + target === melhorJogada) {
                        message.innerHTML = 'Parabéns! Você fez a jogada correta!';
                        setTimeout(() => {
                            movimentoEngine();
                        }, 1000); // Remova as aspas em torno do número para corrigir o atraso
                    } else {
                        message.innerHTML = 'Errou';
                        setTimeout(() => {
                            movimentoEngine();
                        }, 1000); // Remova as aspas em torno do número para corrigir o atraso
                    }
                }
            } else {
                return 'snapback'; // Retorna a peça para a posição original
            }
        }
    };

    var lista_movimentos = [];
    var board = Chessboard('myBoard', config);
    let intervalId;
    let contadorValue;
    const startTimer = () => {
        intervalId = setInterval(() => {
            const currentTime = +timer.innerHTML;
            timer.innerHTML = currentTime + 1;
        }, 1000);
    };
    startTimer();
    const stopTimer = () => {
        clearInterval(intervalId);
        contadorValue = +timer.innerHTML
        alert(contadorValue)
    }

</script>